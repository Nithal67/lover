<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = 'https://rzibufafvrxnbanbnopt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6aWJ1ZmFmdnJ4bmJhbmJub3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjUyNDUsImV4cCI6MjA3OTk0MTI0NX0.hluW9vy-z1Dass6z_q2kLrSdSobzKgNo3WKktCB_92s';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const eventsGrid = document.getElementById('eventsGrid');
const addPopup = document.getElementById('addPopup');
const popup = document.getElementById('popup');
const popupDetails = document.getElementById('popupDetails');

async function loadEvents(){
  const { data, error } = await supabase.from('souvenirs').select('*').order('created_at');
  if(error) return console.error(error);
  renderEvents(data || []);
}

document.getElementById('addEventBtn').addEventListener('click', async () => {
  const name = document.getElementById('eventName').value.trim();
  const date = document.getElementById('eventDate').value;
  const location = document.getElementById('eventLocation').value;
  const mediaInput = document.getElementById('eventMedia');
  const mediaFiles = Array.from(mediaInput.files);

  if(!name || !date) return alert("Nom et date obligatoires ðŸ’–");

  const media = [];
  let count = 0;

  if(mediaFiles.length === 0){
    await supabase.from('souvenirs').insert([{name, date, location, media: []}]);
    loadEvents();
    addPopup.style.display='none';
    return;
  }

  mediaFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = async (e) => {
      media.push({name:file.name,type:file.type,url:e.target.result});
      count++;
      if(count === mediaFiles.length){
        await supabase.from('souvenirs').insert([{name, date, location, media}]);
        loadEvents();
        addPopup.style.display='none';
      }
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('eventName').value='';
  document.getElementById('eventDate').value='';
  document.getElementById('eventLocation').value='';
  mediaInput.value='';
});

function renderEvents(events){
  eventsGrid.innerHTML='';
  events.forEach(e => {
    const div = document.createElement('div');
    div.className='event-card';
    let mediaHTML = '<div style="height:180px;background:#ffe0e6;"></div>';
    if(e.media.length > 0){
      const m = e.media[0];
      if(m.type.startsWith('image')) mediaHTML = `<img src="${m.url}" alt="${e.name}">`;
      else if(m.type.startsWith('video')) mediaHTML = `<video src="${m.url}" autoplay muted loop></video>`;
    }
    div.innerHTML = mediaHTML + `<div class="event-info"><h3>ðŸ’Œ ${e.name}</h3><p>${e.date}</p><p>${e.location||'-'}</p></div>`;
    div.addEventListener('click', () => {
      popupDetails.innerHTML = `<h3>ðŸ’– ${e.name}</h3><p>Date : ${e.date}</p><p>Lieu : ${e.location||'-'}</p>`;
      e.media.forEach(m => {
        if(m.type.startsWith('image')){
          const img = document.createElement('img'); img.src=m.url; img.style.width='100%'; popupDetails.appendChild(img);
        } else if(m.type.startsWith('video')){
          const vid = document.createElement('video'); vid.src=m.url; vid.controls=true; vid.style.width='100%'; popupDetails.appendChild(vid);
        }
      });
      popup.style.display='flex';
    });
    eventsGrid.appendChild(div);
  });
}

document.getElementById('closePopupBtn').addEventListener('click', () => popup.style.display='none');

loadEvents();
</script>
