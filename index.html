<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nos Souvenirs ðŸ’–</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- Supabase UMD bundle depuis unpkg -->
<script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/supabase.umd.js"></script>

<style>
body { margin:0; font-family:'Poppins',sans-serif; background:#ffeef2; color:#333; }
header { background:#ff6b81; color:white; text-align:center; padding:20px; font-family:'Great Vibes', cursive; font-size:2em; box-shadow:0 4px 10px rgba(0,0,0,0.2);}
nav { display:flex; justify-content:center; flex-wrap:wrap; margin:20px 0; }
nav button { background:#fff0f5; border:none; border-radius:30px; padding:12px 25px; margin:5px; cursor:pointer; font-weight:600; font-size:1em; transition:all 0.3s; box-shadow:0 3px 6px rgba(0,0,0,0.1); }
nav button:hover { background:#ffb6c1; color:white; transform:scale(1.05); }
.section { display:none; padding:0 20px 40px; transition:opacity 0.5s; }
.section.active { display:block; }

/* Souvenirs */
button.add-btn { display:block; margin:20px auto; padding:12px 25px; border-radius:25px; background:#ff6b81; color:white; border:none; cursor:pointer; font-weight:bold; font-size:1em; transition:0.3s; }
button.add-btn:hover { background:#ff4757; transform:scale(1.05); }
.events-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin:20px; }
.event-card { background:#fff0f5; border-radius:20px; overflow:hidden; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.1); display:flex; flex-direction:column; transition:transform 0.3s, box-shadow 0.3s; }
.event-card:hover { transform:translateY(-5px); box-shadow:0 6px 20px rgba(0,0,0,0.2);}
.event-card img, .event-card video { width:100%; height:180px; object-fit:cover; }
.event-card .event-info { padding:10px; text-align:center; }
.event-card .event-info h3 { color:#ff6b81; font-family:'Great Vibes', cursive; margin:5px 0; }
.event-card .event-info p { margin:3px 0; font-size:0.85em; color:#555; }

/* Popup */
.popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
.popup-content { background:white; border-radius:20px; max-width:90%; max-height:90%; overflow-y:auto; padding:20px; text-align:center; }
.popup-close { background:#ff6b81; color:white; border:none; border-radius:20px; padding:8px 15px; margin-bottom:10px; cursor:pointer; }
.add-popup input, .add-popup button { width:90%; margin:8px 0; padding:12px; border-radius:20px; border:1px solid #ffc0cb; font-size:1em; box-sizing:border-box; }
.add-popup button { background:#ff6b81; color:white; border:none; cursor:pointer; font-weight:bold; transition:0.3s; }
.add-popup button:hover { background:#ff4757; }

/* Responsive */
@media(max-width:900px){ .events-grid{grid-template-columns:repeat(2,1fr);} }
@media(max-width:600px){ .events-grid{grid-template-columns:1fr;} nav{flex-direction:column;} nav button{margin:5px 0;} }
</style>
</head>
<body>

<header>Nos Souvenirs ðŸ’–</header>

<nav>
  <button id="btnSouvenirs">Souvenirs</button>
</nav>

<div id="souvenirs" class="section">
  <button class="add-btn" id="openAddBtn">Ajouter un souvenir ðŸ’Œ</button>
  <div id="eventsGrid" class="events-grid"></div>
</div>

<!-- POPUP AJOUT -->
<div id="addPopup" class="popup">
  <div class="popup-content add-popup">
    <button class="popup-close" id="closeAddBtn">Fermer</button>
    <h3>Ajouter un souvenir ðŸ’–</h3>
    <input type="text" id="eventName" placeholder="Nom de l'Ã©vÃ©nement">
    <input type="date" id="eventDate">
    <input type="text" id="eventLocation" placeholder="Lieu">
    <input type="file" id="eventMedia" multiple accept="image/*,video/*">
    <button id="addEventBtn">Ajouter ðŸ’Œ</button>
  </div>
</div>

<!-- POPUP DETAILS -->
<div id="popup" class="popup">
  <div class="popup-content">
    <button class="popup-close" id="closePopupBtn">Fermer</button>
    <div id="popupDetails"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  // Supabase client
  const SUPABASE_URL = 'https://rzibufafvrxnbanbnopt.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6aWJ1ZmFmdnJ4bmJhbmJub3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjUyNDUsImV4cCI6MjA3OTk0MTI0NX0.hluW9vy-z1Dass6z_q2kLrSdSobzKgNo3WKktCB_92s';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const eventsGrid = document.getElementById('eventsGrid');

  // Sections
  function showSection(name){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(name).classList.add('active');
  }
  document.getElementById('btnSouvenirs').addEventListener('click', ()=>showSection('souvenirs'));
  showSection('souvenirs');

  // Popups
  function openAddPopup(){ document.getElementById('addPopup').style.display='flex'; }
  function closeAddPopup(){ document.getElementById('addPopup').style.display='none'; }
  function closePopup(){ document.getElementById('popup').style.display='none'; }

  document.getElementById('openAddBtn').addEventListener('click', openAddPopup);
  document.getElementById('closeAddBtn').addEventListener('click', closeAddPopup);
  document.getElementById('closePopupBtn').addEventListener('click', closePopup);

  // Fetch & Render
  async function fetchEvents(){
    const { data, error } = await supabaseClient.from('souvenirs').select('*').order('created_at', {ascending:true});
    if(error){ console.error(error); return; }
    renderEvents(data);
  }

  function renderEvents(events){
    eventsGrid.innerHTML='';
    events.forEach(e=>{
      const div=document.createElement('div'); div.className='event-card';
      let mediaHTML='<div style="height:180px;background:#ffe0e6;"></div>';
      if(e.media){
        const m = JSON.parse(e.media)[0];
        if(m.type.startsWith('image')) mediaHTML=`<img src="${m.url}" alt="${e.name}">`;
        else if(m.type.startsWith('video')) mediaHTML=`<video src="${m.url}" autoplay muted loop></video>`;
      }
      div.innerHTML = mediaHTML + `<div class="event-info"><h3>ðŸ’Œ ${e.name}</h3><p>${e.date}</p><p>${e.location||'-'}</p></div>`;
      div.onclick = ()=>openPopup(e);
      eventsGrid.appendChild(div);
    });
  }

  function openPopup(event){
    const popup=document.getElementById('popup');
    const details=document.getElementById('popupDetails');
    details.innerHTML=`<h3>ðŸ’– ${event.name}</h3><p>Date : ${event.date}</p><p>Lieu : ${event.location||'-'}</p>`;
    if(event.media){
      JSON.parse(event.media).forEach(m=>{
        if(m.type.startsWith('image')){
          const img = document.createElement('img'); img.src = m.url; img.style.width='100%'; details.appendChild(img);
        } else if(m.type.startsWith('video')){
          const vid = document.createElement('video'); vid.src=m.url; vid.controls=true; vid.style.width='100%'; details.appendChild(vid);
        }
      });
    }
    popup.style.display='flex';
  }

  // Add Event
  document.getElementById('addEventBtn').addEventListener('click', async ()=>{
    const name = document.getElementById('eventName').value;
    const date = document.getElementById('eventDate').value;
    const location = document.getElementById('eventLocation').value;
    const mediaInput = document.getElementById('eventMedia');
    const mediaFiles = Array.from(mediaInput.files);
    if(!name||!date) return alert("Nom et date obligatoires ðŸ’–");

    const media = [];
    for(const file of mediaFiles){
      const reader = new FileReader();
      await new Promise(resolve=>{
        reader.onload = e=>{ media.push({name:file.name,type:file.type,url:e.target.result}); resolve(); };
        reader.readAsDataURL(file);
      });
    }

    const { error } = await supabaseClient.from('souvenirs').insert([{name,date,location,media:JSON.stringify(media)}]);
    if(error){ console.error(error); alert("Erreur lors de l'ajout."); return; }

    closeAddPopup();
    document.getElementById('eventName').value='';
    document.getElementById('eventDate').value='';
    document.getElementById('eventLocation').value='';
    mediaInput.value='';

    fetchEvents();
  });

  fetchEvents();
});
</script>

</body>
</html>
